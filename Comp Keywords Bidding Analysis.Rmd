---
title: "Competitors Keywords Bidding Analysis"
author: "Jiying Lu"
date: "3/30/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#
#Environment set up
```{r}
library(data.table)
library(MASS)
library(foreign)
library(gplots)
library(lmtest)
library(usdm)
library(sandwich)
library(plyr)
library(ggplot2)
install.packages("reshape2")
library(reshape2)
library(calibrate)
library(car)
library(cluster)
install.packages("rcompanion")
library(rcompanion)

rm(list=ls())  
setwd("/Users/lucute/Desktop/SCU/MKT Analytics/Project")
fdf <- read.csv(file.choose())
```

## Business Questions:
1. In general, does bidding on competitive keywords help our sales or damage competitors' sales?
2. In which regions/segments, does bidding on competitive keywords have the greatest negative impact on the competition’s sales?
3. For the regions/segments that bidding has a negative impact, which segments/regions should we focus?
4. For a particular region/segments, against which competitor do we have the greatest opportunity to impact sales negatively? 
5. Nationally, if sales for a particular one of Ford’s models are slumping, in which region do we see the greatest likelihood of successfully attacking our competitors?  Which competitor is the most vulnerable?  Which model (if not belonging to that competitor) is the most vulnerable? 

## Take a look of data:
```{r}
dim(fdf) # 126720 observations, 36 variables
head(fdf)
summary(fdf)
count(fdf$segment) #1,2,3,5,7,8,9,10,11,12,13,14,15,16 lowest:1920
count(fdf$region) #1-32
count(fdf$brand) #1-14 lowest:1920
```

## Analysis Strategy:
1.Based on the following reasons: first, both our and competitors' sales varies from different segments, regions, and time periods, second, the spend on this month may have greater effect on next month or next two month's sales, I use the gap between our and competitors' next month (next two month) sales as dependent variable.
2.For the segment perspective, I separate the data into 14 different segments and try to find the "most fitted" model for each segment. From these different models, I can observe the impact of keyword bidding on the gap of sales. I assume the error terms for these models may correlate across each others so that seemingly unrelated regressions can be applied for this analysis. However, I don't have equal observations among the segments, the alternative plan is to run the ols first and random select equal observations for each segment, then use SUR to approach the models again. By comparing the coefficients of these two different regressions, there may be some interesting findings.
3.I do have equal amount of observations for each region, so I'll do the same approaches as segment part but using full data set instead.

#Plots of data (TBD)
```{r}
sub <- as.data.table(cbind(my = fdf$month_year,total = fdf$total_segment_sales, ford = fdf$ford_sales, comp = fdf$comp_sales, segment = fdf$segment, year = fdf$year))
sub$index <- paste(sub$segment,sub$my,sep = "_")
sub1 <- sub[sub$year == 2012]

sub1$my <- NULL
sub1$segment <- NULL
sub1$year <- NULL
subm1 <- melt.data.table(sub1,measure.vars = c("ford","total","comp"))

ggplot(data = subm1, aes(x = index, y = value, group = variable)) + 
  geom_line(aes(color = variable))

```
From the plot, I found that in general, our and comp's sales are moving together with total_segment_sales.
-> The ratio or gap between us, comps, and total sales can be dependent variable, too.

#Generate variables
```{r}
#Sales gap - previous month
fdf$salesgap = fdf$ford_sales - fdf$comp_sales

#Sales gap - next month
fdf$salesgap_ahead = fdf$ford_sales_ahead_one - fdf$comp_sales_ahead_one

#Sales gap - next two month
fdf$salesgap_ahead_two = fdf$ford_sales_ahead_two - fdf$comp_sales_ahead_two

fdf$salesgap_lag_one = fdf$ford_sales_lag_one - fdf$comp_sales_lag_one

```

#Take a look for the x variables
```{r}
colSums(is.na(fdf))
?plotNormalHistogram

plotNormalHistogram(fdf$salesgap)

plotNormalHistogram(fdf$salesgap_ahead)

plotNormalHistogram(fdf$cost)
plotNormalHistogram(log(fdf$cost+1))
plotNormalHistogram(sign(fdf$cost) * abs(fdf$cost)^(1/3))
plotNormalHistogram(sqrt(fdf$cost))
fdf$cost_log <- log(fdf$cost+1)


plotNormalHistogram(fdf$impressions)
plotNormalHistogram(log(fdf$impressions+1))
plotNormalHistogram(sign(fdf$impressions) * abs(fdf$impressions)^(1/3))
fdf$imp_cub = sign(fdf$impressions) * abs(fdf$impressions)^(1/3)

plotNormalHistogram(fdf$clicks)
plotNormalHistogram(log(fdf$clicks+1))
plotNormalHistogram(sign(fdf$clicks) * abs(fdf$clicks)^(1/3))
fdf$click_cub = sign(fdf$clicks) * abs(fdf$clicks)^(1/3)

plotNormalHistogram(fdf$click_thru_rate)
plotNormalHistogram(log(fdf$click_thru_rate+1))
plotNormalHistogram(sign(fdf$click_thru_rate) * abs(fdf$click_thru_rate)^(1/3))
fdf$ctr_cub = sign(fdf$click_thru_rate) * abs(fdf$click_thru_rate)^(1/3)

plotNormalHistogram(fdf$engagement)
plotNormalHistogram(log(fdf$engagement+1))
plotNormalHistogram(sign(fdf$engagement) * abs(fdf$engagement)^(1/3))
fdf$eng_cub = sign(fdf$engagement) * abs(fdf$engagement)^(1/3)

plotNormalHistogram(fdf$engagement_per_click)
summary(fdf$engagement_per_click)
plotNormalHistogram(log(fdf$engagement_per_click+1))
plotNormalHistogram(sign(fdf$engagement_per_click) * abs(fdf$engagement_per_click)^(1/3))
fdf$epc_log = log(fdf$engagement_per_click+1)

plotNormalHistogram(fdf$cost_per_engagement)
summary(fdf$cost_per_engagement)
plotNormalHistogram(log(fdf$cost_per_engagement+1))
plotNormalHistogram(sign(fdf$cost_per_engagement) * abs(fdf$cost_per_engagement)^(1/3))
fdf$cpe_log = log(fdf$cost_per_engagement +1)

plotNormalHistogram(fdf$cost_per_click)
plotNormalHistogram(log(fdf$cost_per_click+1))
plotNormalHistogram(sign(fdf$cost_per_click) * abs(fdf$cost_per_click)^(1/3))
fdf$cpc_log = log(fdf$cost_per_click +1)


plotNormalHistogram(fdf$quality_score)
summary(fdf$quality_score)
plotNormalHistogram(log(fdf$quality_score+1))
plotNormalHistogram(sign(fdf$quality_score) * abs(fdf$quality_score)^(1/3))
fdf$qua_cub = sign(fdf$quality_score) * abs(fdf$quality_score)^(1/3)

plotNormalHistogram(fdf$price)
plotNormalHistogram(log(fdf$price+1))
plotNormalHistogram(sign(fdf$price) * abs(fdf$price)^(1/3))

plotNormalHistogram(fdf$incentives_percent)
plotNormalHistogram(log(fdf$incentives_percent+1))
plotNormalHistogram(sign(fdf$incentives_percent) * abs(fdf$incentives_percent)^(1/3) *10)

plotNormalHistogram(fdf$tv_spend)
plotNormalHistogram(log(fdf$tv_spend+1))
plotNormalHistogram(sign(fdf$tv_spend) * abs(fdf$tv_spend)^(1/3))
fdf$tv_cub = sign(fdf$tv_spend) * abs(fdf$tv_spend)^(1/3)

plotNormalHistogram(fdf$digital_spend)
plotNormalHistogram(log(fdf$digital_spend+1))
plotNormalHistogram(sign(fdf$digital_spend) * abs(fdf$digital_spend)^(1/3))
fdf$digi_log = log(fdf$digital_spend+1)

plotNormalHistogram(fdf$total_spend)
plotNormalHistogram(log(fdf$total_spend+1))
plotNormalHistogram(sign(fdf$total_spend) * abs(fdf$total_spend)^(1/3))
fdf$total_log = log(fdf$total_spend+1)

```


#Check multicollinearity
```{r}
co <- cbind.data.frame(fdf[11:45])
corr <- cor(co)
vifcor(co)

co1 <- cbind.data.frame(fdf[40:51])
corr1 <- cor(co1)
vifcor(co1)

vifcor(cbind(fdf$ctr_cub, fdf$epc_log))
vifcor(cbind(fdf$cost_log, fdf$cpc_log))

#Don't use clicks and engagement
#Use the combination of ctr and epc for further analysis

co2 <- cbind.data.frame(fdf[26:41])
corr2 <- cor(co2)
vifcor(cbind(fdf$comp_sales, fdf$ford_sales, fdf$total_segment_sales, fdf$salesgap))
vifcor(cbind(fdf$comp_sales, fdf$ford_sales))
vifcor(cbind(fdf$comp_sales, fdf$ford_sales, fdf$total_segment_sales))

```

Analysis - Segment
#Segment1
```{r}
s1 <- fdf[fdf$segment == "Segment1",]

s1_1_1 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s1 )
summary(s1_1_1)
AIC(s1_1_1) #75374.21
dwtest(s1_1_1)

s1_1_2 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + qua_cub + tv_cub + digi_log + total_segment_sales, data = s1 )
summary(s1_1_2)
AIC(s1_1_2) #75374.04

s1_1_3 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + salesgap + qua_cub + tv_cub + digi_log + total_segment_sales, data = s1 )
summary(s1_1_3)
AIC(s1_1_3) #75697.51

#s1_1_2

```

#Segment 2
```{r}
s2 <- fdf[fdf$segment == "Segment2",]
s2_1_1 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s2 )
summary(s2_1_1)
AIC(s2_1_1) #220613.1
dwtest(s2_1_1)

s2_1_2 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + qua_cub + tv_cub + digi_log + total_segment_sales, data = s2 )
summary(s2_1_2)
AIC(s2_1_2) #220611.3

s2_1_3 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + qua_cub + total_log + total_segment_sales, data = s2 )
summary(s2_1_3)
AIC(s2_1_3) #220611.3

s2_1_4 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + qua_cub + tv_cub + total_segment_sales, data = s2 )
summary(s2_1_4)
AIC(s2_1_4) #220612.4

#s2_1_2


```

#Segment3
```{r}
s3 <- fdf[fdf$segment == "Segment3",]
s3_1_1 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s3 )
summary(s3_1_1)
AIC(s3_1_1) #231859.5
dwtest(s3_1_1)

s3_1_2 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + digi_log + total_segment_sales, data = s3 )
summary(s3_1_2)
AIC(s3_1_2) #231857.5

s3_1_3 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + digi_log + total_segment_sales, data = s3 )
summary(s3_1_3)
AIC(s3_1_3) #231855.9

s3_1_4 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + digi_log + total_segment_sales + origin, data = s3 )
summary(s3_1_4)
AIC(s3_1_4)

#s3_1_3

```

#Segment5
```{r}

s5 <- fdf[fdf$segment == "Segment5",]
s5_1_1 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s5 )
summary(s5_1_1)
AIC(s5_1_1) #92309.49
dwtest(s5_1_1)

s5_1_2 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s5 )
summary(s5_1_2)
AIC(s5_1_2) #92307.53

s5_1_3 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + epc_log + tv_cub + digi_log + total_segment_sales, data = s5 )
summary(s5_1_3)
AIC(s5_1_3) #92306.13

s5_1_4 <- lm(salesgap_ahead ~ brand + region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + epc_log + digi_log + total_segment_sales, data = s5 )
summary(s5_1_4)
AIC(s5_1_4) #92305.36

```

```{r}
s7 <- fdf[fdf$segment == "Segment7",]
summary(s7)
s7_1_1 <- lm(salesgap_ahead ~ region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s7 )
summary(s7_1_1)
AIC(s7_1_1) #15035.94
#At this segment, Ford didn't sell any car.

s7_1_2 <- lm(salesgap_ahead ~ region + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s7 )
summary(s7_1_2)
AIC(s7_1_2) #15035.94

vifcor(cbind(s7$incentives_percent, s7$price, s7$cost_log, s7$comp_sales))


```

```{r}
s8 <- fdf[fdf$segment == "Segment8",]
summary(s8)
s8_1_1 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s8 )
summary(s8_1_1)
AIC(s8_1_1) #94369.82
dwtest(s8_1_1)

s8_1_2 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s8 )
summary(s8_1_2)
AIC(s8_1_2) #94368.04

s8_1_3 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + tv_cub + digi_log + total_segment_sales, data = s8 )
summary(s8_1_3)
AIC(s8_1_3) #94366.31


```

```{r}
s9 <- fdf[fdf$segment == "Segment9",]
summary(s9)
s9_1_1 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s9 )
summary(s9_1_1)
AIC(s9_1_1) #34202.55
dwtest(s9_1_1)

s9_1_2 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + tv_cub + digi_log + total_segment_sales, data = s9 )
summary(s9_1_2)
AIC(s9_1_2) #34201.19

s9_1_3 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + total_log + total_segment_sales, data = s9 )
summary(s9_1_3)
AIC(s9_1_3) #34198.84

s9_1_4 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + total_segment_sales, data = s9 )
summary(s9_1_4)
AIC(s9_1_4) #34197.29


```

```{r}
s10 <- fdf[fdf$segment == "Segment10",]
summary(s10)
s10_1_1 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s10 )
summary(s10_1_1)
AIC(s10_1_1) #141949.4
dwtest(s10_1_1)

s10_1_2 <- lm(salesgap_ahead ~ region + brand + factor(month_year) + cost_log + price + incentives_percent + comp_sales + ford_sales + ctr_cub + epc_log + qua_cub + tv_cub + digi_log + total_segment_sales, data = s10 )
summary(s10_1_1)
AIC(s10_1_1)


```

